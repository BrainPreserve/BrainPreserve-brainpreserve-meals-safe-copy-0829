<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Brain Healthy Meal Generator — Standalone</title>
  <style>
    :root{ --bg:#f7f8fb; --fg:#111; --muted:#667085; --card:#fff; --line:#e5e7eb; --accent:#0a60ff; }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f7f8fb;color:#111}
    main{max-width:980px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 8px}
    h2{margin:0 0 8px}
    .subtitle{color:#475467;margin:0 0 12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:18px;box-shadow:0 4px 14px rgba(0,0,0,.04);margin:18px 0}
    textarea{width:100%;padding:12px;border:1px solid #d0d5dd;border-radius:12px}
    .row{display:flex;align-items:center;gap:10px;margin:10px 0;flex-wrap:wrap}
    input[type="number"]{width:120px;padding:10px;border:1px solid #d0d5dd;border-radius:12px}
    button{padding:10px 14px;border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:12px;cursor:pointer}
    button.ghost{border-color:#d0d5dd;background:#fff;color:#111}
    button:disabled{opacity:.6;cursor:not-allowed}
    .btn-row{display:flex;gap:10px;flex-wrap:wrap}
    pre{white-space:pre-wrap;background:#ffffff;color:#111111;padding:14px;border-radius:12px;min-height:48px;margin-top:12px;border:1px solid #e5e7eb}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:860px){.grid{grid-template-columns:1fr}}
    .accordion{border:1px dashed #d6d6d6;border-radius:12px;margin:10px 0;overflow:hidden;background:#fff}
    .acc-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:#f9fafb;cursor:pointer}
    .acc-header h4{margin:0;font-size:15px}
    .acc-content{display:none;padding:12px 14px;background:#fff}
    .acc-content.open{display:block}
    .checks{display:flex;flex-wrap:wrap;gap:8px}
    .checks label{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid #e5e7eb;border-radius:10px}
    .muted{color:#667085;font-size:13px;margin:0 0 6px}
    table{width:100%; border-collapse:collapse; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden}
    th, td{padding:10px; border-bottom:1px solid #f1f5f9}
    thead tr{background:#f9f9fb}
    th{ text-align:left; vertical-align:top; white-space:normal; word-wrap:break-word }
    td.num{ text-align:right }
    .status{font-size:12px;color:#475467;margin-top:8px}
    .error{color:#b42318;background:#fef3f2;border:1px solid #fed7d7;padding:8px;border-radius:8px;margin-top:8px}

    /* 5-table stack styles */
    .bp-table{ border-collapse:collapse; width:100%; margin:12px 0 18px 0; font-size:14px; }
    .bp-table th,.bp-table td{ border:1px solid #e5e7eb; padding:6px 8px; vertical-align:top; }
    .bp-table th{ background:#f7f7fb; font-weight:600; }
    .bp-total td{ font-weight:700; background:#f9fafb; }
    .bp5stack h3{ margin:18px 0 8px 0; }
    .bp-footnote{ color:#667085; font-size:12px; margin:-6px 0 12px 0; }
    .bp-after{ margin-top:10px; }
  </style>
</head>
<body>
  <main>
    <h1>Brain Healthy Meal Generator</h1>
    <p class="subtitle">Choose ingredients, set goals, or type a custom request. Recipes and coaching appear inline—no new tab.</p>

    <!-- A) Custom Request -->
    <section class="card">
      <h2>Custom Request</h2>
      <p>Example: “Make 3 dinners with salmon and legumes, dairy-free, low sodium.” Leave the number blank to default to 5 recipes.</p>
      <textarea id="custom-input" rows="4" placeholder="Describe the meal(s) you want..."></textarea>
      <div class="row">
        <label for="num-recipes">Number of recipes (optional):</label>
        <input id="num-recipes" type="number" min="1" max="10" placeholder="5" />
      </div>
      <div class="btn-row">
        <button onclick="generateFromCustom()">Generate Recipes</button>
        <button class="ghost" type="button" onclick="clearCustomSection()">Clear Custom</button>
      </div>
      <pre id="custom-output"></pre>
      <!-- 5-table stacks appear directly beneath this pre -->
    </section>

    <!-- B) Build From Ingredients -->
    <section class="card">
      <h2>Build From Ingredients</h2>
      <p>Select ingredients to include and categories to exclude. Your selections preview below.</p>

      <div class="grid">
        <div>
          <h3>Include Ingredients</h3>
          <div id="include-root"></div>
        </div>

        <div>
          <div class="accordion" id="exclude-accordion">
            <div class="acc-header" role="button" tabindex="0" aria-expanded="false" onclick="toggleAccordion(this)">
              <h4>Exclude Categories</h4>
              <span class="muted">Click to expand</span>
            </div>
            <div class="acc-content">
              <p class="muted">Check entire categories to exclude them (e.g., “Dairy”).</p>
              <div class="checks" id="exc-categories"></div>
            </div>
          </div>

          <div class="accordion" id="goals-accordion">
            <div class="acc-header" role="button" tabindex="0" aria-expanded="false" onclick="toggleAccordion(this)">
              <h4>Nutrition Goals</h4>
              <span class="muted">Click to expand</span>
            </div>
            <div class="acc-content">
              <p class="muted">Select one or more goals to tailor coaching suggestions.</p>
              <div class="checks" id="goals"></div>
            </div>
          </div>

          <!-- NEW: number of recipes for the selector -->
          <div class="row">
            <label for="num-recipes-form">Number of recipes (optional):</label>
            <input id="num-recipes-form" type="number" min="1" max="10" placeholder="5" />
          </div>
        </div>
      </div>

      <h3>Preview</h3>
      <pre id="form-preview">No selections yet.</pre>

      <div class="btn-row">
        <button onclick="generateFromSelections()">Generate Recipes from Selections</button>
        <button class="ghost" type="button" onclick="clearFormSelections()">Clear Form</button>
      </div>

      <div id="status" class="status"></div>

      <!-- (kept for compatibility; tables are injected near outputs) -->
      <div id="nutrition-root" class="card" style="display:none"></div>
    </section>
  </main>

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // =========================
    // CONFIG
    // =========================
    const CFG = {
      generateEndpoint: '/.netlify/functions/generate',
      enableNutrition: true,  // inject 5 tables per recipe
      datasets: {
        categories:          'data/categories.csv',
        diet_tool:           'data/diet_tool.csv',
        fiber:               'data/fiber.csv',
        gi_gl:               'data/gi_gl.csv',
        main:                'data/main.csv',
        microbiome:          'data/microbiome.csv',
        micronutrients_list: 'data/micronutrients_list.csv',
        micronutrients_food: 'data/micronutrients_food.csv',
        moder:               'data/moder.csv',
        protein:             'data/protein.csv'
      }
    };

    // =========================
    // UI SOURCES (unchanged)
    // =========================
    const STARTER_INGREDIENTS = {
      "Vegetables": ["GPT CHOOSES VEGETABLES","Arugula","Collard Greens","Kale","Mustard Greens","Romaine","Spinach","Swiss Chard","Broccoli","Brussel Sprouts","Cabbage","Cauliflower","Bell Peppers","Chili Peppers","Eggplant","Tomatoes","Beets","Carrots","Sweet Potatoes","Artichokes","Asparagus","Celery","Cucumber","Onions","Zucchini","Mushrooms","Cornmeal (whole grain)","Blue Corn","Sweet Corn","Grits (whole grain, cooked)","Heirloom Corn","Hominy Corn","Purple Corn","Polenta (cooked)"],
      "Legumes": ["GPT CHOOSES LEGUMES","Chickpeas","Edamame","Green Peas","Lentils","Lupins","Miso","Natto","Peanuts","Soybeans","Split Peas","Tempeh","Tofu","Adzuki Beans","Black Beans","Kidney Beans","Mung Beans","Navy Beans","Pinto beans"],
      "Fruit": ["GPT CHOOSES FRUIT","Apples","Avocados","Blackberries","Blueberries","Cranberries","Golgi Berries","Gooseberries","Grapes","Kiwis","Mulberries","Olives","Passion Fruit","Raspberries","Strawberries","Orange","Grapefruit","Lemon","Cherries","Watermelon","Black currants (Dried)","Bilberries (Dried)","Cranberries (Dried)","Prunes","Dates","Figs","Raisins","Gooseberries (Dried)","Mulberries (Dried)"],
      "Fish": ["GPT CHOOSES FISH","Anchovies","Herring","Mackerel","Salmon","Sardines","Flounder","Sea Bass","Sturgeon","Trout","Yellow Catfish"],
      "Whole Grains": ["GPT CHOOSES WHOLE GRAINS","Amaranth","Barley","Brown Rice","Farro","Millet","Oats/Oat Groats/Steel Cut/Rolled","Quinoa","Whole Grain (Bread)","Whole Wheat"],
      "Nuts/Seeds": ["GPT CHOOSES NUTS OR SEEDS","Almonds","Almond Milk","Brazil Nuts","Cashews","Hazelnuts","Macadamia Nuts","Pecans","Pistachios","Walnuts","Chia Seeds","Flaxseeds","Pumpkin Seeds","Sesame Seeds","Sunflower Seeds"],
      "Meat": ["GPT CHOOSES THE MEAT","Chicken Breast (skinless)","Turkey","Lamb","Pork Liver"],
      "Pasta": ["GPT CHOOSES PASTA","Beet Pasta","Brown Rice Pasta","Buckwheat (Soba) Noodles","Chickpea Pasta","Lentil Pasta","Quinoa Pasta","Semolina Pasta","Sourdough Pasta","Spelt Pasta","Spinach Pasta","Whole Grain Pasta (non-wheat options)","Whole Wheat Pasta"],
      "Dairy": ["GPT CHOOSES DAIRY","Asiago Cheese","Brie Cheese","Blue Cheese","Camembert Cheese","Cheddar Cheese","Edam Cheese","Gouda Cheese","Gruyère Cheese","Parmesan Cheese","Provolone Cheese","Romano Cheese","Swiss Cheese","Cottage Cheese","Feta Cheese","Limburger Cheese","Mozzarella Cheese (if fermented)","Tilsit Cheese","Yogurt (Fermented)","Low-fat Milk","Kefir"],
      "Oils": ["GPT CHOOSES THE OIL","Avocado Oil (Cold-pressed, expeller-pressed)","Olive Oil (Extra Virgin -Cold-pressed)","Algae Oil","Cod Liver Oil","Krill Oil","Seaweed OIl","Chia Seed Oil","Flaxseed Oil","Hemp Seed Oil","Camellia Oil","Canola/Rapeseed Oil","Peony Oil","Pomegranate Seed Oiil","Safflower Oil","Sesame Oil","Soybean Oil","Sunflower Oil","Walnut Oil"],
      "Fermented Foods": ["Apple Cider Vinegar","Balsamic Vinegar","Kefir","Kimchi","Kombucha (Unsweetened)","Sauerkraut","Yogurt (Fermented)"],
      "Other Ingredients": ["GPT CHOOES OTHER (EGGS, COFFEE, TEA, HONEY, OTHERS)","Cacao","Capers","Coffee","Eggs","Green Tea","Honey","Kombucha (Unsweetened)","Seaweed","Soy Milk"]
    };
    const EXCLUDE_CATEGORIES = Object.keys(STARTER_INGREDIENTS);
    const GOALS = [
      "General Cognitive Health",
      "Weight Loss / Metabolic Health",
      "Blood Sugar Control (Low GI/GL)",
      "Cardiovascular Support (Low Sodium / Healthy Fats)",
      "Sleep Support",
      "Anti-inflammatory Focus (Lower DII)",
      "Microbiome Support (Pre/Pro/Post-biotic)"
    ];

    // =========================
    // HELPERS
    // =========================
    function el(tag, attrs={}, ...children){
      const node = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=>{
        if(k==='class') node.className = v;
        else if(k==='for') node.setAttribute('for', v);
        else if(k==='html') node.innerHTML = v;
        else node.setAttribute(k,v);
      });
      children.forEach(c => node.append(c));
      return node;
    }
    function slugify(s){ return String(s||'').toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,''); }
    function toggleAccordion(header){
      const acc = header.parentElement;
      const content = acc.querySelector('.acc-content');
      const open = content.classList.toggle('open');
      header.setAttribute('aria-expanded', open ? 'true' : 'false');
    }
    function setStatus(msg){ const s=document.getElementById('status'); if(s) s.textContent = msg; }
    const $ = (sel)=>document.querySelector(sel);

    // Checkbox renderer
    function renderIncludeAccordions(){
      const root = document.getElementById('include-root');
      root.innerHTML = '';
      Object.entries(STARTER_INGREDIENTS).forEach(([cat, items])=>{
        const catSlug = slugify(cat);
        const acc = el('div', { class:'accordion' });
        const header = el('div', { class:'acc-header', role:'button', tabindex:'0', 'aria-expanded':'false', onclick:'toggleAccordion(this)' },
          el('h4', {}, cat),
          el('span', { class:'muted' }, 'Click to expand')
        );
        const content = el('div', { class:'acc-content' });
        const list = el('div', { class:'checks' });
        items.forEach(val=>{
          const id = `inc-${catSlug}-${slugify(val)}`;
          const input = el('input', { type:'checkbox', id, value:val, 'data-cat':catSlug });
          const label = el('label', { for:id }, input, val);
          list.appendChild(label);
        });
        content.appendChild(list);
        acc.appendChild(header); acc.appendChild(content);
        root.appendChild(acc);
      });
    }

    function renderChecks(containerId, items){
      const root = document.getElementById(containerId); root.innerHTML = '';
      items.forEach(v=>{
        const id = `${containerId}-${slugify(v)}`;
        const input = el('input', { type:'checkbox', id, value:v });
        const label = el('label', { for:id }, input, v);
        root.appendChild(label);
      });
    }

    function getSelectedByCat(){
      const inputs = document.querySelectorAll('input[type=checkbox][data-cat]');
      const out = {};
      inputs.forEach(i=>{
        const cat = i.getAttribute('data-cat');
        if (i.checked){ (out[cat] ||= []).push(i.value); }
      });
      return out;
    }
    function getSelected(containerId){
      const root = document.getElementById(containerId);
      const inputs = root ? root.querySelectorAll('input[type=checkbox]:checked') : [];
      return Array.from(inputs).map(i=>i.value);
    }

    function collectForm(){
      const selections = {};
      Object.keys(STARTER_INGREDIENTS).forEach(cat=>{
        const slug = slugify(cat);
        selections[cat] = getSelectedByCat()[slug] || [];
      });
      const exclusions = getSelected('exc-categories');
      const goals = getSelected('goals');
      const numForm = parseInt($('#num-recipes-form')?.value, 10);
      const count = Number.isFinite(numForm) && numForm > 0 ? Math.min(numForm, 10) : 5; // default to 5
      return { selections, exclusions, goals, count };
    }
    function buildPreviewText(data){
      const parts = [];
      for (const [cat, list] of Object.entries(data.selections)) {
        if (list && list.length) parts.push(`${cat}: ${list.join(', ')}`);
      }
      if (data.exclusions?.length) parts.push(`Exclude categories: ${data.exclusions.join(', ')}`);
      if (data.goals?.length) parts.push(`Goals: ${data.goals.join(', ')}`);
      parts.push(`Number of recipes: ${data.count}`);
      return parts.length ? parts.join('\n') : 'No selections yet.';
    }

    // =========================
    // OPENAI VIA NETLIFY FUNCTION (unchanged)
    // =========================
    async function callOpenAI(messages){
      const resp = await fetch(CFG.generateEndpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages, temperature: 0.4, max_tokens: 1200, model: 'gpt-4o-mini' })
      });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data?.error || ('HTTP '+resp.status));
      return data?.content || '';
    }

    // =========================
    // CSV LOADING + 5-TABLE ENGINE (abridged but robust)
    // =========================
    const DATA = { ready:false, rows:0, db:Object.create(null) };
    const COLS = {
      ingredient:     ['Ingredient','Ingredients','Food','Item','Name','Food Name','Ingredient Name'],
      calories:       ['Calories','kcal','Calories_per_serving'],
      protein_g:      ['Protein (g)','Protein_g','Protein'],
      fiber_g:        ['Fiber (g)','Fiber_g','Fiber'],
      gi:             ['GI','Glycemic Index'],
      gl:             ['GL','Glycemic Load'],
      dii:            ['DII Score','DII','AntiInflammatoryScore','Anti-Inflammatory/DII','Anti-Inflammatory/DII Score (lower is better)'],
      key_micros:     ['Key Micronutrients','Key Nutrients/Bioactives','Key_Nutrients'],
      micro_type:     ['Microbiome Prebiotic or Probiotic or Postbiotic','Microbiome_Type','Pre/Pro/Postbiotic','Microbiome Type'],
      micro_score:    ['Microbiome Benefit Score','Microbiome_Score','Benefit Score'],
      diets_list:     ['Compatible Diets','Diets','Diet_Compat','Diet Tags'],
      serving_size:   ['Serving Size','Serving','Common Serving'],
      mech_fn:        ['Mechanism/Function','Mechanism','Function'],
      sources_details:['Notable Sources/Details','Notes','Details'],
      cog_benefits:   ['Cognitive Benefits & Mechanisms','Cognitive_Benefits','Cognition_Mechanisms'],
      other_benefits: ['Other Health Benefits','Other_Benefits']
    };
    const POSSIBLE_DIETS = ['MIND','Mediterranean','DASH','LowGI','Pescetarian','Vegetarian','Vegan','Keto','Paleo','GlutenFree','DairyFree','AntiInflammatory','Modern'];
    const NAME_ALIAS = {'extra virgin olive oil':'olive oil','ev olive oil':'olive oil','rolled oats':'oats','baby spinach':'spinach','greek yogurt':'yogurt','brown rice':'rice','wild salmon':'salmon','chickpeas':'garbanzo beans'};

    const esc = s=>String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const toKey = s => (s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9\s\-]/g,'').replace(/\s+/g,' ').trim();
    const num = v => { if(v==null) return null; const x=parseFloat(String(v).replace(/[^\d\.\-]/g,'')); return Number.isFinite(x)?x:null; };
    const fmt = (v,d=0) => (v==null || !Number.isFinite(v) ? 'N/A' : (d===0 ? String(Math.round(v)) : v.toFixed(d)));
    const pick = (row, names) => { for (const n of names){ if(n in row && row[n]!=='' && row[n]!=null) return row[n]; } };
    function canonical(raw){
      let s = String(raw||'').toLowerCase();
      s = s.replace(/\(.*?\)/g,'').replace(/\b(fresh|chopped|diced|minced|cooked|raw|organic|extra|virgin|ground|dry|dried|toasted|unsalted|salted|low\-fat|nonfat|skinless|boneless)\b/g,'');
      s = s.replace(/\s+/g,' ').trim(); if (NAME_ALIAS[s]) s = NAME_ALIAS[s];
      if (s.endsWith('s') && !s.endsWith('ss')) s = s.slice(0,-1);
      return s;
    }
    async function loadCSV(path){
      return new Promise((resolve)=> Papa.parse(path, {
        download:true, header:true, dynamicTyping:false, skipEmptyLines:'greedy',
        complete:(res)=>resolve(res.data || []), error:()=>resolve([])
      }));
    }
    async function ensureDataLoaded(){
      if (!CFG.enableNutrition || DATA.ready) return;
      for (const path of Object.values(CFG.datasets)){
        const rows = await loadCSV(path);
        for (const r0 of rows){
          const r={}; for (const k in r0) r[k.trim()] = r0[k];
          const name = pick(r, COLS.ingredient) || r[Object.keys(r)[0]];
          if (!name) continue;
          const key = toKey(canonical(name));
          const dst = (DATA.db[key] ||= { _name:name, _rows:[] }); dst._rows.push(r); DATA.rows++;

          const fields = [
            ['calories',COLS.calories],['protein_g',COLS.protein_g],['fiber_g',COLS.fiber_g],
            ['gi',COLS.gi],['gl',COLS.gl],['dii',COLS.dii],['key_micros',COLS.key_micros],
            ['micro_type',COLS.micro_type],['micro_score',COLS.micro_score],['diets_list',COLS.diets_list],
            ['serving_size',COLS.serving_size],['mech_fn',COLS.mech_fn],['sources_details',COLS.sources_details],
            ['cog_benefits',COLS.cog_benefits],['other_benefits',COLS.other_benefits]
          ];
          for (const [k,aliases] of fields){
            if (dst[k]==null){
              const v = pick(r, aliases);
              if (v!=null && String(v).trim()!=='') dst[k]=v;
            }
          }
        }
      }
      DATA.ready=true;
    }

    // ---------- Parse GPT text for recipes ----------
    function normLine(s){
      return String(s||'')
        .replace(/[*_`~>#]/g,'')
        .replace(/\u2022/g,'-')
        .replace(/\r/g,'')
        .trim();
    }
    function isIngredientsLine(s){ return /^ingredients?\b/.test(normLine(s).toLowerCase()); }
    function isStopLine(s){
      const t = normLine(s).toLowerCase();
      return !t || /^instructions?\b/.test(t) || /^method\b/.test(t) || /^directions?\b/.test(t) || /^notes?\b/.test(t);
    }
    function likelyTitle(s){
      const t = normLine(s);
      return t && !/^\-|\*|\d+\./.test(t) && !/^ingredients?/i.test(t) && t.length <= 120;
    }
    function parseRecipesFromText(txt){
      const rawLines = String(txt||'').split('\n');
      const lines = rawLines.map(normLine);
      const recipes=[];
      for (let i=0;i<lines.length;i++){
        if (!isIngredientsLine(lines[i])) continue;
        let title = null;
        for (let k=i-1, seen=0; k>=0 && seen<3; k--){
          if (!lines[k]) continue;
          if (likelyTitle(lines[k])){ title = lines[k].replace(/^\d+\.\s*/,'').trim(); break; }
          seen++;
        }
        if (!title) title = `Recipe ${recipes.length+1}`;
        const items=[];
        for (let j=i+1; j<lines.length; j++){
          const L = lines[j];
          if (isStopLine(L)) break;
          if (/^\s*(-|\*|\d+\.)\s*/.test(rawLines[j]) || /^[\d\/\.\,]+\s*[a-zA-Zµ]*\s+/.test(L) || /^[A-Za-z]/.test(L)){
            if (L.length>0) items.push(L);
          } else if (!L) break; else if (/^[A-Z]/.test(L)) break;
        }
        if (items.length) recipes.push({ title, ingredients: items });
      }
      return recipes;
    }

    // ---------- Build & inject the 5 tables ----------
    function attachByName(recName){
      const key = toKey(canonical(recName));
      return DATA.db[key] || { _name: recName };
    }
    function buildTablesForIngredients(list){
      const rows = list.map(raw=>{
        const m = raw.match(/^([\d\/\.\,\s\-]+)?\s*([a-zA-Zµ]+)?\s*(.*)$/);
        const namePart = m ? (m[3]||raw) : raw;
        const rec = attachByName(namePart);
        const display = rec._name || namePart;
        return { display, rec };
      }).sort((a,b)=>a.display.localeCompare(b.display));

      const t1 = buildNutritionTable(rows);
      const t2 = buildCogTable(rows);
      const t3 = buildDietTable(rows);
      const t4 = buildMicrobiomeTable(rows);
      const t5 = buildMicronutrientBenefitsTable(rows);
      return `<div class="bp5stack">${t1}${t2}${t3}${t4}${t5}</div>`;
    }
    function buildNutritionTable(rows){
      let totCal=0, totProt=0, totFib=0, totGL=0;
      const body = rows.map(r=>{
        const d=r.rec||{};
        const cal=num(d.calories); if(cal!=null) totCal+=cal;
        const pr=num(d.protein_g); if(pr!=null) totProt+=pr;
        const fi=num(d.fiber_g);   if(fi!=null) totFib+=fi;
        const gi=num(d.gi);
        const gl=num(d.gl);        if(gl!=null) totGL+=gl;
        const dii = (d.dii!=null && String(d.dii).trim()!=='') ? d.dii : 'N/A';
        const keyMicros = d.key_micros ?? 'N/A';
        const mType = d.micro_type ?? 'N/A';
        const mScore = d.micro_score ?? 'N/A';
        return `<tr>
          <td>${esc(r.display)}</td>
          <td>${fmt(cal)}</td>
          <td>${fmt(pr)}</td>
          <td>${fmt(fi)}</td>
          <td>${gi==null?'N/A':fmt(gi)}</td>
          <td>${gl==null?'N/A':fmt(gl)}</td>
          <td>${esc(String(dii))}</td>
          <td>${esc(String(keyMicros))}</td>
          <td>${esc(String(mType))}</td>
          <td>${esc(String(mScore))}</td>
        </tr>`;
      }).join('');
      const totals = `<tr class="bp-total">
        <td>Totals</td><td>${fmt(totCal)}</td><td>${fmt(totProt)}</td><td>${fmt(totFib)}</td><td>—</td><td>${fmt(totGL)}</td><td>—</td><td>—</td><td>—</td><td>—</td>
      </tr>`;
      return `
        <h3>1. Nutrition Table</h3>
        <table class="bp-table">
          <thead>
            <tr>
              <th>Ingredient</th>
              <th>Calories</th>
              <th>Protein (g)</th>
              <th>Fiber (g)</th>
              <th>GI</th>
              <th>GL</th>
              <th>Anti-Inflammatory/<wbr>DII Score<br>(lower is better)</th>
              <th>Key Micronutrients</th>
              <th>Microbiome Prebiotic or Probiotic or Postbiotic</th>
              <th>Microbiome Benefit Score</th>
            </tr>
          </thead>
          <tbody>${body}${totals}</tbody>
        </table>
      `;
    }
    function buildCogTable(rows){
      const body = rows.map(r=>{
        const d=r.rec||{};
        return `<tr><td>${esc(r.display)}</td><td>${esc(d.cog_benefits ?? 'N/A')}</td><td>${esc(d.other_benefits ?? 'N/A')}</td></tr>`;
      }).join('');
      return `
        <h3>2. Cognitive &amp; Other Health Benefits Table</h3>
        <table class="bp-table">
          <thead><tr><th>Ingredient</th><th>Cognitive Benefits &amp; Mechanisms</th><th>Other Health Benefits</th></tr></thead>
          <tbody>${body}</tbody>
        </table>
      `;
    }
    function buildDietTable(rows){
      const body = rows.map(r=>{
        const d=r.rec||{};
        let diets = d.diets_list;
        if (!diets) diets = deriveDietList(d._rows || []);
        return `<tr><td>${esc(r.display)}</td><td>${esc(diets ? String(diets) : 'N/A')}</td></tr>`;
      }).join('');
      return `
        <h3>3. Diet Compatibility Table</h3>
        <table class="bp-table">
          <thead><tr><th>Ingredient</th><th>Compatible Diets</th></tr></thead>
          <tbody>${body}</tbody>
        </table>
      `;
    }
    function deriveDietList(rows){
      if(!rows.length) return null;
      const yes=new Set();
      for (const r of rows){
        for (const d of POSSIBLE_DIETS){
          if (d in r){
            const v = String(r[d]).toLowerCase();
            if (['1','y','yes','true','✓','x'].includes(v)) yes.add(d);
          }
        }
      }
      return yes.size ? Array.from(yes).sort().join(', ') : null;
    }
    function buildMicrobiomeTable(rows){
      const body = rows.map(r=>{
        const d=r.rec||{};
        return `<tr><td>${esc(r.display)}</td><td>${esc(d.micro_type ?? 'N/A')}</td><td>${esc(d.micro_score ?? 'N/A')}</td></tr>`;
      }).join('');
      return `
        <h3>4. Microbiome Benefit Table</h3>
        <table class="bp-table">
          <thead><tr><th>Ingredient</th><th>Microbiome Prebiotic or Probiotic or Postbiotic</th><th>Microbiome Benefit Score</th></tr></thead>
          <tbody>${body}</tbody>
        </table>
      `;
    }
    function buildMicronutrientBenefitsTable(rows){
      const body = rows.map(r=>{
        const d=r.rec||{};
        const serving = d.serving_size ?? 'N/A';
        const keyN = d.key_micros ?? 'N/A';
        const mech = d.mech_fn ?? 'N/A';
        const srcs = d.sources_details ?? 'N/A';
        const pct = estimatePercentRDA(d);
        return `<tr><td>${esc(r.display)}</td><td>${esc(serving)}</td><td>${esc(keyN)}</td><td>${esc(mech)}</td><td>${esc(srcs)}</td><td>${esc(pct ?? 'N/A')}</td></tr>`;
      }).join('');
      return `
        <h3>5. Micronutrient Benefits Table</h3>
        <table class="bp-table">
          <thead>
            <tr>
              <th>Ingredient</th>
              <th>Serving Size</th>
              <th>Key Nutrients/Bioactives</th>
              <th>Mechanism/Function</th>
              <th>Notable Sources/Details</th>
              <th>% Recommended Daily Amount</th>
            </tr>
          </thead>
          <tbody>${body}</tbody>
        </table>
        <div class="bp-footnote">%RDA shown when present/derivable in your CSVs; otherwise “N/A”.</div>
      `;
    }
    function estimatePercentRDA(rec){
      try{
        const rows = rec._rows || [];
        for (const row of rows){
          for (const k in row){
            const key = k.toLowerCase();
            if (/%\s*rda/.test(key) || /rda_%/.test(key) || /percent[_\s]?rda/.test(key)){
              const v = parseFloat(String(row[k]).replace(/[^\d\.\-]/g,''));
              if (Number.isFinite(v)) return String(Math.round(v));
            }
          }
        }
        return null;
      } catch { return null; }
    }

    // ---------- Injection ----------
    async function injectTablesAfter(preEl, text){
      if (!CFG.enableNutrition || !preEl) return;
      await ensureDataLoaded();

      if (preEl.nextElementSibling && preEl.nextElementSibling.classList?.contains('bp-after')){
        preEl.nextElementSibling.remove();
      }
      const container = document.createElement('div');
      container.className = 'bp-after';

      const recipes = parseRecipesFromText(text);
      if (!recipes.length){
        container.innerHTML = '<div class="muted">No recognizable “Ingredients” section was found in the generated text.</div>';
        preEl.insertAdjacentElement('afterend', container);
        return;
      }

      recipes.forEach((R, idx)=>{
        const sec = document.createElement('section');
        sec.className = 'bp5stack';
        sec.innerHTML = `
          <h2 style="margin:8px 0">${esc(R.title || ('Recipe ' + (idx+1)))}</h2>
          <h3>Ingredients</h3>
          <ul>${R.ingredients.map(it=>`<li>${esc(it)}</li>`).join('')}</ul>
          ${buildTablesForIngredients(R.ingredients)}
        `;
        container.appendChild(sec);
      });

      preEl.insertAdjacentElement('afterend', container);
    }

    // =========================
    // PUBLIC HANDLERS
    // =========================
    async function generateFromCustom(){
      setStatus('');
      const out = $('#custom-output');
      const custom = $('#custom-input').value.trim();
      const numRaw = parseInt($('#num-recipes').value, 10);
      const count = Number.isFinite(numRaw) && numRaw>0 ? Math.min(numRaw,10) : 5; // default 5

      const sys = `You are BrainPreserve’s recipe engine. Generate exactly ${count} brain-healthy recipes. For each recipe, include a heading and a heading "Ingredients" followed by a bullet list of ingredients with amounts (markdown bullets). Keep formatting simple.`;
      const user = `Request: ${custom || 'Chef’s choice within brain-healthy constraints.'}`;

      out.textContent = 'Generating...';
      try{
        const text = await callOpenAI([{ role:'system', content: sys }, { role:'user', content: user }]);
        out.textContent = text || '(no text)';
        await injectTablesAfter(out, text);
      }catch(err){ out.textContent = 'Error: ' + err.message; }
    }

    function clearCustomSection(){
      $('#custom-input').value = '';
      $('#num-recipes').value = '';
      const pre = $('#custom-output');
      pre.textContent = '';
      if (pre.nextElementSibling && pre.nextElementSibling.classList?.contains('bp-after')) pre.nextElementSibling.remove();
    }

    function clearFormSelections(){
      document.querySelectorAll('.checks input[type=checkbox]').forEach(i => { i.checked = false; });
      $('#num-recipes-form').value = '';
      $('#form-preview').textContent = 'No selections yet.';
      const out = $('#form-output'); if (out) out.remove();
      // remove any injected stacks that might follow form-output
      const pre = $('#form-output');
      if (pre && pre.nextElementSibling && pre.nextElementSibling.classList?.contains('bp-after')) pre.nextElementSibling.remove();
      setStatus('');
    }

    async function generateFromSelections(){
      setStatus('Working…');

      const form = collectForm();
      $('#form-preview').textContent = buildPreviewText(form);

      let out = $('#form-output');
      if (!out){ out = document.createElement('pre'); out.id='form-output'; out.className='card'; document.querySelector('main').appendChild(out); }
      out.textContent = 'Generating...';

      try {
        const selLines = Object.entries(form.selections)
          .filter(([, list]) => list && list.length)
          .map(([k, list]) => `${k}: ${list.join(', ')}`)
          .join('\n');
        const exc = form.exclusions?.length ? `Exclude categories: ${form.exclusions.join(', ')}` : '';
        const goals = form.goals?.length ? `Goals: ${form.goals.join(', ')}` : '';

        const sys = `You are BrainPreserve’s recipe engine. Use the provided selections, respect exclusions strictly, tailor to the listed goals, and return exactly ${form.count} recipes. For each recipe, include a heading and a heading "Ingredients" followed by a bullet list of ingredients with amounts (markdown bullets).`;
        const user = `Selections:\n${selLines || '(none)'}\n${exc}\n${goals}`;

        const text = await callOpenAI([{ role:'system', content: sys }, { role:'user', content: user }]);
        out.textContent = text || '(no text)';
        await injectTablesAfter(out, text);

        setStatus('Done.');
      } catch(err){
        out.textContent = '';
        const errBox = el('div',{class:'error'}, 'Error during generation: ', String(err?.message || err));
        out.replaceWith(errBox); errBox.id='form-output';
        console.error(err);
        setStatus('Error.');
      }
    }

    // =========================
    // INIT
    // =========================
    (async function init(){
      renderIncludeAccordions();
      renderChecks('exc-categories', EXCLUDE_CATEGORIES);
      renderChecks('goals', GOALS);
      document.body.addEventListener('change', (e)=>{
        if(e.target.closest('.checks')){
          const form = collectForm();
          $('#form-preview').textContent = buildPreviewText(form);
        }
      });
      await ensureDataLoaded();
    })();

    // Export handlers
    window.generateFromSelections = generateFromSelections;
    window.generateFromCustom     = generateFromCustom;
    window.clearFormSelections    = clearFormSelections;
    window.clearCustomSection     = clearCustomSection;
    window.toggleAccordion        = toggleAccordion;
  </script>
</body>
</html>
